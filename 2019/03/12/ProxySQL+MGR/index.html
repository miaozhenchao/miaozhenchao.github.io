<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ProxySQL+MGR | ZhenChaoNotes</title><meta name="description" content="ProxySQL 是基于 MySQL 的一款开源的中间件的产品 1可以实现读写分离，支持Query路由功能，支持动态指定某个SQL进行cache，支持动态加载配置、故障切换和一些SQL的过滤功能。还有一些同类产品比如DBproxy、MyCAT、OneProxy等。  介绍基于传统异步复制和半同步复制的缺陷——数据的一致性问题无法保证，MySQL官方在5.7.17版本正式推出组复制（MySQL G"><meta name="keywords" content="ProxySQL,MGR"><meta name="author" content="MiaoZhenChao"><meta name="copyright" content="MiaoZhenChao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.luanyu.cool/2019/03/12/ProxySQL+MGR/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="ProxySQL+MGR"><meta property="og:url" content="http://www.luanyu.cool/2019/03/12/ProxySQL+MGR/"><meta property="og:site_name" content="ZhenChaoNotes"><meta property="og:description" content="ProxySQL 是基于 MySQL 的一款开源的中间件的产品 1可以实现读写分离，支持Query路由功能，支持动态指定某个SQL进行cache，支持动态加载配置、故障切换和一些SQL的过滤功能。还有一些同类产品比如DBproxy、MyCAT、OneProxy等。  介绍基于传统异步复制和半同步复制的缺陷——数据的一致性问题无法保证，MySQL官方在5.7.17版本正式推出组复制（MySQL G"><meta property="og:image" content="https://ssyerv1.oss-cn-hangzhou.aliyuncs.com/picture/b63ba4dd15334a819ef187c482845267.jpg!sswm"><meta property="article:published_time" content="2019-03-12T08:05:20.000Z"><meta property="article:modified_time" content="2020-08-28T11:04:43.657Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="linux wa%过高，iostat查看io状况" href="http://www.luanyu.cool/2019/03/13/linux-wa%%E8%BF%87%E9%AB%98%EF%BC%8Ciostat%E6%9F%A5%E7%9C%8Bio%E7%8A%B6%E5%86%B5/"><link rel="next" title="戴尔惠普服务器配置及价格" href="http://www.luanyu.cool/2019/03/12/%E6%88%B4%E5%B0%94%E6%83%A0%E6%99%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E5%8F%8A%E4%BB%B7%E6%A0%BC/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: MiaoZhenChao","link":"链接: ","source":"来源: ZhenChaoNotes","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/touming.css"><link rel="stylesheet" href="/css/iconfont.css"><script src="/js/sakura.js"></script><div class="aplayer" data-id="5184835907" data-server="netease" data-type="playlist" data-fixed="true" data-listFolded="false" data-order="random" data-preload="auto"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lete114/CDN/music/APlayer/APlayer.min.css"><script src="https://cdn.jsdelivr.net/gh/lete114/CDN/music/APlayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script><meta name="generator" content="Hexo 4.2.1"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">97</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">74</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">54</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont  icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/diary/"><i class="fa-fw iconfont  icon-riji"></i><span> 舔狗日记</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 个人简历</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#介绍"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#通过MGR-ProxySQL可以实际主节点故障时应用无感应自动切换到新的主节点。“自动故障恢复“和“读写分离“"><span class="toc-number">1.0.1.</span> <span class="toc-text">通过MGR+ProxySQL可以实际主节点故障时应用无感应自动切换到新的主节点。“自动故障恢复“和“读写分离“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一、环境准备"><span class="toc-number">2.</span> <span class="toc-text">一、环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、在三个节点上安装Mysql5-7"><span class="toc-number">3.</span> <span class="toc-text">二、在三个节点上安装Mysql5.7</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、MySQL-yum包下载"><span class="toc-number">3.1.</span> <span class="toc-text">1、MySQL yum包下载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、MySQL-软件源安转"><span class="toc-number">3.2.</span> <span class="toc-text">2、MySQL 软件源安转</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、MySQL-服务安装"><span class="toc-number">3.3.</span> <span class="toc-text">3、MySQL 服务安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4、MySQL-服务启动"><span class="toc-number">3.4.</span> <span class="toc-text">4、MySQL 服务启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5、MySQL-服务运行状态检查"><span class="toc-number">3.5.</span> <span class="toc-text">5、MySQL 服务运行状态检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6、MySQL-修改临时密码"><span class="toc-number">3.6.</span> <span class="toc-text">6、MySQL 修改临时密码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7、登陆并修改密码"><span class="toc-number">3.7.</span> <span class="toc-text">7、登陆并修改密码</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1、使用默认的密码登陆"><span class="toc-number">3.7.1.</span> <span class="toc-text">1、使用默认的密码登陆</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2、修改密码"><span class="toc-number">3.7.2.</span> <span class="toc-text">2、修改密码</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8、解决不符合密码复杂性要求"><span class="toc-number">3.8.</span> <span class="toc-text">8、解决不符合密码复杂性要求**</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1、修改-密码策略-将策略要求置为LOW，长度要求置为1"><span class="toc-number">3.8.1.</span> <span class="toc-text">1、修改 密码策略  将策略要求置为LOW，长度要求置为1</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2、修改密码的长度"><span class="toc-number">3.8.2.</span> <span class="toc-text">2、修改密码的长度</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3、再次修改密码成功"><span class="toc-number">3.8.3.</span> <span class="toc-text">3、再次修改密码成功</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、MGR组复制环境部署-多写模式"><span class="toc-number">4.</span> <span class="toc-text">三、MGR组复制环境部署 (多写模式)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#四、ProxySQL读写分离和主节点故障无感知切换"><span class="toc-number">5.</span> <span class="toc-text">四、ProxySQL读写分离和主节点故障无感知切换</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-安装mysql客户端，用于在本机连接到ProxySQL的管理接口"><span class="toc-number">5.1.</span> <span class="toc-text">1) 安装mysql客户端，用于在本机连接到ProxySQL的管理接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-安装proxysql"><span class="toc-number">5.2.</span> <span class="toc-text">2) 安装proxysql</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3）在数据库端建立proxysql登入需要的帐号-（在三个MGR任意一个节点上操作，会自动同步到其他节点）"><span class="toc-number">5.3.</span> <span class="toc-text">3）在数据库端建立proxysql登入需要的帐号 （在三个MGR任意一个节点上操作，会自动同步到其他节点）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-创建检查MGR节点状态的函数和视图-（在三个MGR任意一个节点上操作，会自动同步到其他节点）"><span class="toc-number">5.4.</span> <span class="toc-text">4) 创建检查MGR节点状态的函数和视图 （在三个MGR任意一个节点上操作，会自动同步到其他节点）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-在proxysql中增加帐号"><span class="toc-number">5.5.</span> <span class="toc-text">5) 在proxysql中增加帐号</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7）配置scheduler"><span class="toc-number">5.6.</span> <span class="toc-text">7）配置scheduler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-设置读写分离"><span class="toc-number">5.7.</span> <span class="toc-text">8) 设置读写分离</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-验证数据的读写分离效果"><span class="toc-number">5.8.</span> <span class="toc-text">9) 验证数据的读写分离效果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10）设置故障应用无感应"><span class="toc-number">5.9.</span> <span class="toc-text">10）设置故障应用无感应</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><header class="post-bg" id="page-header" style="background-image: url(https://ssyerv1.oss-cn-hangzhou.aliyuncs.com/picture/b63ba4dd15334a819ef187c482845267.jpg!sswm)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">ZhenChaoNotes</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont  icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/diary/"><i class="fa-fw iconfont  icon-riji"></i><span> 舔狗日记</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 个人简历</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">ProxySQL+MGR</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2019-03-12 16:05:20"><i class="fa-fw far fa-calendar-alt"></i> 发表于 2019-03-12</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/ProxySQL-MGR/">ProxySQL+MGR</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta__icon"></i><span>字数总计:</span><span class="word-count">8.3k</span><span class="post-meta__separator">|</span><i class="far fa-clock fa-fw post-meta__icon"></i><span>阅读时长: 42 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="far fa-comments fa-fw post-meta__icon"></i><span>评论数:</span><span class="disqus-comment-count comment-count"><a href="http://www.luanyu.cool/2019/03/12/ProxySQL+MGR/#disqus_thread"></a></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><img src= "/img/loading.gif" data-src="/2019/03/12/ProxySQL+MGR/image-20200821112405285.png" alt="image-20200821112405285"></p>
<p>ProxySQL 是基于 MySQL 的一款开源的中间件的产品</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以实现读写分离，支持Query路由功能，支持动态指定某个SQL进行cache，支持动态加载配置、故障切换和一些SQL的过滤功能。还有一些同类产品比如DBproxy、MyCAT、OneProxy等。</span><br></pre></td></tr></table></figure>

<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a><strong>介绍</strong></h4><p>基于传统异步复制和半同步复制的缺陷——数据的一致性问题无法保证，MySQL官方在5.7.17版本正式推出组复制（MySQL Group Replication，简称MGR）。</p>
<p>由若干个节点共同组成一个复制组，一个事务的提交，必须经过组内大多数节点（N / 2 +  1）决议并通过，才能得以提交。如上图所示，由3个节点组成一个复制组，Consensus层为一致性协议层，在事务提交过程中，发生组间通讯，由2个节点决议(certify)通过这个事务，事务才能够最终得以提交并响应。</p>
<p>引入组复制，主要是为了解决传统异步复制和半同步复制可能产生数据不一致的问题。组复制依靠分布式一致性协议(Paxos协议的变体)，实现了分布式下数据的最终一致性，提供了真正的数据高可用方案(是否真正高可用还有待商榷)。其提供的多写方案，给我们实现多活方案带来了希望。</p>
<h6 id="通过MGR-ProxySQL可以实际主节点故障时应用无感应自动切换到新的主节点。“自动故障恢复“和“读写分离“"><a href="#通过MGR-ProxySQL可以实际主节点故障时应用无感应自动切换到新的主节点。“自动故障恢复“和“读写分离“" class="headerlink" title="通过MGR+ProxySQL可以实际主节点故障时应用无感应自动切换到新的主节点。“自动故障恢复“和“读写分离“"></a>通过MGR+ProxySQL可以实际主节点故障时应用无感应自动切换到新的主节点。“自动故障恢复“和“读写分离“</h6><p>根据上图，描述下实现思路：三个节点使multi-primary（多主）的方式连接，应用通过连接ProxySQL [ˈprɑːksi]中间件，根据sql的属性（是否为select语句）来决定连接哪一个节点，一个可写节点，两个只读节点（其实三个都是可写节点，只不过通过proxysql进行了读写分离）。如果默认的可写节点挂掉的话，proxysql通过定期运行的调度器会将另一个只读节点的其中一台设为可写节点，实际主节点故障应用无感应的要求。上述的整个过程中，应用无需任何变动。应用从意识发生了故障，到连接重新指向新的主，正常提供服务，秒级别的间隔。</p>
<h4 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a><strong>一、环境准备</strong></h4><table>
<thead>
<tr>
<th>192.168.219.151</th>
<th>mgr-node1</th>
<th>centos7.6</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.219.152</td>
<td>mgr-node2</td>
<td>centos7.6</td>
</tr>
<tr>
<td>192.168.219.153</td>
<td>mgr-node3</td>
<td>centos7.6</td>
</tr>
<tr>
<td>192.168.219.154</td>
<td>proxysql-node</td>
<td>centos7.6</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@mgr-node1 ~]# cat /etc/hosts</span><br><span class="line">......</span><br><span class="line">192.168.219.151 mgr-node1</span><br><span class="line">192.168.219.152 mgr-node2</span><br><span class="line">192.168.219.153 mgr-node3</span><br><span class="line">192.168.219.154 proxysql-node</span><br></pre></td></tr></table></figure>

<h4 id="二、在三个节点上安装Mysql5-7"><a href="#二、在三个节点上安装Mysql5-7" class="headerlink" title="二、在三个节点上安装Mysql5.7"></a><strong>二、在三个节点上安装Mysql5.7</strong></h4><h5 id="1、MySQL-yum包下载"><a href="#1、MySQL-yum包下载" class="headerlink" title="1、MySQL yum包下载"></a>1、MySQL yum包下载</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# wget http://repo.mysql.com/mysql57-community-release-el7-10.noarch.rpm</span><br></pre></td></tr></table></figure>

<h5 id="2、MySQL-软件源安转"><a href="#2、MySQL-软件源安转" class="headerlink" title="2、MySQL 软件源安转"></a>2、MySQL 软件源安转</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# yum -y install mysql57-community-release-el7-10.noarch.rpm</span><br></pre></td></tr></table></figure>

<h5 id="3、MySQL-服务安装"><a href="#3、MySQL-服务安装" class="headerlink" title="3、MySQL 服务安装"></a>3、MySQL 服务安装</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# yum install  -y  mysql-community-server mysql</span><br></pre></td></tr></table></figure>

<h5 id="4、MySQL-服务启动"><a href="#4、MySQL-服务启动" class="headerlink" title="4、MySQL 服务启动"></a>4、MySQL 服务启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# systemctl start mysqld.service</span><br></pre></td></tr></table></figure>

<h5 id="5、MySQL-服务运行状态检查"><a href="#5、MySQL-服务运行状态检查" class="headerlink" title="5、MySQL 服务运行状态检查"></a>5、MySQL 服务运行状态检查</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# systemctl status mysqld.service</span><br></pre></td></tr></table></figure>

<h5 id="6、MySQL-修改临时密码"><a href="#6、MySQL-修改临时密码" class="headerlink" title="6、MySQL 修改临时密码"></a>6、MySQL 修改临时密码</h5><ul>
<li>为了加强安全性，MySQL5.7为root用户随机生成了一个密码，在error log中，关于error log的位置，如果安装的是RPM包，则默认是/var/log/mysqld.log。</li>
<li>只有启动过一次mysql才可以查看临时密码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]<span class="comment"># grep 'temporary password' /var/log/mysqld.log</span></span><br></pre></td></tr></table></figure>

<h5 id="7、登陆并修改密码"><a href="#7、登陆并修改密码" class="headerlink" title="7、登陆并修改密码"></a>7、登陆并修改密码</h5><h6 id="1、使用默认的密码登陆"><a href="#1、使用默认的密码登陆" class="headerlink" title="1、使用默认的密码登陆"></a>1、使用默认的密码登陆</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# mysql -uroot -p"默认密码"</span><br></pre></td></tr></table></figure>

<h6 id="2、修改密码"><a href="#2、修改密码" class="headerlink" title="2、修改密码"></a>2、修改密码</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;123456&#39;;</span><br></pre></td></tr></table></figure>

<h5 id="8、解决不符合密码复杂性要求"><a href="#8、解决不符合密码复杂性要求" class="headerlink" title="8、解决不符合密码复杂性要求**"></a><strong><em>8、解决不符合密码复杂性要求**</em></strong></h5><p>MySQL5.6.6版本之后增加了密码强度验证插件validate_password，相关参数设置的较为严格。使用了该插件会检查设置的密码是否符合当前设置的强度规则，若不满足则拒绝设置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">登陆数据库查看</span><br><span class="line">mysql&gt; show variables like &#39;validate_password%&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">| Variable_name                        | Value |</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">| validate_password_dictionary_file    |       |</span><br><span class="line">| validate_password_length             | 8     |</span><br><span class="line">| validate_password_mixed_case_count   | 1     |</span><br><span class="line">| validate_password_number_count       | 1     |</span><br><span class="line">| validate_password_policy             | LOW   |</span><br><span class="line">| validate_password_special_char_count | 1     |</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">1、validate_password_policy</span><br><span class="line">代表的密码策略，可配置的值有以下：默认是MEDIUM</span><br><span class="line">0 or LOW 仅需需符合密码长度（由参数validate_password_length指定）</span><br><span class="line">1 or MEDIUM 满足LOW策略，同时还需满足至少有1个数字，小写字母，大写字母和特殊字符</span><br><span class="line">2 or STRONG 满足MEDIUM策略，同时密码不能存在字典文件（dictionary file）中</span><br><span class="line"> </span><br><span class="line">2、validate_password_dictionary_file</span><br><span class="line"># 用于配置密码的字典文件，当validate_password_policy设置为STRONG时可以配置密码字典文件，字典文件中存在的密码不得使用。</span><br><span class="line"> </span><br><span class="line">3、validate_password_length</span><br><span class="line"># 用来设置密码的最小长度，默认值是8最小是0</span><br><span class="line"> </span><br><span class="line">4、validate_password_mixed_case_count   </span><br><span class="line"># 当validate_password_policy设置为MEDIUM或者STRONG时，密码中至少同时拥有的小写和大写字母的数量，默认是1最小是0；默认是至少拥有一个小写和一个大写字母。</span><br><span class="line"> </span><br><span class="line">5、validate_password_number_count     </span><br><span class="line"># 当validate_password_policy设置为MEDIUM或者STRONG时，密码中至少拥有的数字的个数，默认1最小是0</span><br><span class="line"> </span><br><span class="line">6、validate_password_special_char_count</span><br><span class="line"># 当validate_password_policy设置为MEDIUM或者STRONG时，密码中至少拥有的特殊字符的个数，默认1最小是0</span><br></pre></td></tr></table></figure>



<h6 id="1、修改-密码策略-将策略要求置为LOW，长度要求置为1"><a href="#1、修改-密码策略-将策略要求置为LOW，长度要求置为1" class="headerlink" title="1、修改 密码策略  将策略要求置为LOW，长度要求置为1"></a>1、修改 密码策略  将策略要求置为LOW，长度要求置为1</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global validate_password_policy&#x3D;0;</span><br></pre></td></tr></table></figure>

<h6 id="2、修改密码的长度"><a href="#2、修改密码的长度" class="headerlink" title="2、修改密码的长度"></a>2、修改密码的长度</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global validate_password_length&#x3D;1;</span><br></pre></td></tr></table></figure>

<h6 id="3、再次修改密码成功"><a href="#3、再次修改密码成功" class="headerlink" title="3、再次修改密码成功"></a>3、再次修改密码成功</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;123456&#39;;</span><br></pre></td></tr></table></figure>

<h4 id="三、MGR组复制环境部署-多写模式"><a href="#三、MGR组复制环境部署-多写模式" class="headerlink" title="三、MGR组复制环境部署 (多写模式)"></a><strong>三、MGR组复制环境部署 (多写模式)</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">由于之前做了其他测试，这里需要将三个节点的mysql环境抹干净：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl stop mysqld</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf /var/lib/mysql</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl start mysqld</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">然后重启密码</span><br><span class="line"><span class="meta">#</span><span class="bash"> cat /var/<span class="built_in">log</span>/mysqld.log|grep <span class="string">'A temporary password'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql -p123456</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password_policy=0;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password_length=1;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> password=password(<span class="string">"123456"</span>);</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">=======================================================</span><br><span class="line">1） MGR-node1节点操作</span><br><span class="line">[root@mgr-node1 ~]# mysql -uroot -p"123456"</span><br><span class="line">.........</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select uuid();</span></span><br><span class="line">+--------------------------------------+</span><br><span class="line">| uuid()                               |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| 58462f3b-ccd9-11ea-8eb2-000c29c57992 |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>后面三台配置文件中的uuid都使用node1节点的uuid</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">https://www.cnblogs.com/mysql-hongling/p/9556679.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash">上方链接有文件中参数的相关解释</span></span><br><span class="line">[root@mgr-node1 ~]# cp /etc/my.cnf&#123;,.bak&#125;</span><br><span class="line">[root@mgr-node1 ~]# &gt;/etc/my.cnf</span><br><span class="line">[root@mgr-node1 ~]# cat /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">socket = /var/lib/mysql/mysql.sock</span><br><span class="line">        </span><br><span class="line">symbolic-links = 0</span><br><span class="line">        </span><br><span class="line">log-error = /var/log/mysqld.log</span><br><span class="line">pid-file = /var/run/mysqld/mysqld.pid</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash">GTID:</span></span><br><span class="line">server_id = 1</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">    </span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">        </span><br><span class="line"><span class="meta">#</span><span class="bash">binlog</span></span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">log-slave-updates = 1</span><br><span class="line">binlog_format = row</span><br><span class="line">sync-master-info = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">       </span><br><span class="line"><span class="meta">#</span><span class="bash">relay <span class="built_in">log</span></span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line">    </span><br><span class="line">transaction_write_set_extraction=XXHASH64     </span><br><span class="line">loose-group_replication_group_name="58462f3b-ccd9-11ea-8eb2-000c29c57992"    </span><br><span class="line">loose-group_replication_start_on_boot=off   </span><br><span class="line">loose-group_replication_local_address= "192.168.219.151:24901"</span><br><span class="line">loose-group_replication_group_seeds= "192.168.219.151:24901,192.168.219.152:24901,192.168.219.153:24901"</span><br><span class="line">loose-group_replication_bootstrap_group=off</span><br><span class="line">loose-group_replication_single_primary_mode=off     </span><br><span class="line">loose-group_replication_enforce_update_everywhere_checks=on   </span><br><span class="line">loose-group_replication_ip_whitelist="192.168.219.0/24,127.0.0.1/8"</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">重启mysql服务</span><br><span class="line">[root@mgr-node1 ~]# systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">登录mysql进行相关设置操作</span><br><span class="line">[root@mgr-node1 ~]# mysql -uroot -p"123456"</span><br><span class="line">......</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=0;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">下面我执行报错了，采用最上面的方式解决</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO rpl_slave@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'slave@123'</span>;</span></span><br><span class="line">ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password_policy=0;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password_length=1;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">再次执行就可以了</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO rpl_slave@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'slave@123'</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">  reset master;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=1;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">  CHANGE MASTER TO MASTER_USER=<span class="string">'rpl_slave'</span>, MASTER_PASSWORD=<span class="string">'slave@123'</span> FOR CHANNEL <span class="string">'group_replication_recovery'</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSTALL PLUGIN group_replication SONAME <span class="string">'group_replication.so'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.14 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW PLUGINS;</span></span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library              | License |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| mysql_native_password      | ACTIVE   | AUTHENTICATION     | NULL                 | GPL     |</span><br><span class="line">| ............................................................................................|</span><br><span class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">46 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL group_replication_bootstrap_group=ON;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START GROUP_REPLICATION;</span></span><br><span class="line">Query OK, 0 rows affected (2.21 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL group_replication_bootstrap_group=OFF;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | aa42205a-cc7b-11ea-a8c3-000c29c57992 | mgr-node1   |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">比如要保证上面的group_replication_applier的状态为<span class="string">"ONLINE"</span>才对！</span></span><br><span class="line"> </span><br><span class="line">创建一个测试库</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE DATABASE kevin CHARACTER SET utf8 COLLATE utf8_general_ci;   </span></span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use kevin;</span></span><br><span class="line">Database changed</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create table <span class="keyword">if</span> not exists haha (id int(10) PRIMARY KEY AUTO_INCREMENT,name varchar(50) NOT NULL);</span></span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> insert into kevin.haha values(1,<span class="string">"wangshibo"</span>),(2,<span class="string">"guohuihui"</span>),(3,<span class="string">"yangyang"</span>),(4,<span class="string">"shikui"</span>);</span></span><br><span class="line">Query OK, 4 rows affected (0.16 sec)</span><br><span class="line">Records: 4  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from kevin.haha;</span></span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | wangshibo |</span><br><span class="line">|  2 | guohuihui |</span><br><span class="line">|  3 | yangyang  |</span><br><span class="line">|  4 | shikui    |</span><br><span class="line">+----+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">=====================================================================</span><br><span class="line">2） MGR-node2节点操作</span><br><span class="line">[root@mgr-node2 ~]# cp /etc/my.cnf&#123;,.bak&#125;</span><br><span class="line">[root@mgr-node2 ~]# &gt;/etc/my.cnf</span><br><span class="line">[root@mgr-node2 ~]# cat /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">socket = /var/lib/mysql/mysql.sock</span><br><span class="line">      </span><br><span class="line">symbolic-links = 0</span><br><span class="line">      </span><br><span class="line">log-error = /var/log/mysqld.log</span><br><span class="line">pid-file = /var/run/mysqld/mysqld.pid</span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash">GTID:</span></span><br><span class="line">server_id = 2</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">  </span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">      </span><br><span class="line"><span class="meta">#</span><span class="bash">binlog</span></span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">log-slave-updates = 1</span><br><span class="line">binlog_format = row</span><br><span class="line">sync-master-info = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">     </span><br><span class="line"><span class="meta">#</span><span class="bash">relay <span class="built_in">log</span></span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line">  </span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name="58462f3b-ccd9-11ea-8eb2-000c29c57992"</span><br><span class="line">loose-group_replication_start_on_boot=off</span><br><span class="line">loose-group_replication_local_address= "192.168.219.152:24901"</span><br><span class="line">loose-group_replication_group_seeds= "192.168.219.151:24901,192.168.219.152:24901,192.168.219.153:24901"</span><br><span class="line">loose-group_replication_bootstrap_group=off</span><br><span class="line">loose-group_replication_single_primary_mode=off</span><br><span class="line">loose-group_replication_enforce_update_everywhere_checks=on</span><br><span class="line">loose-group_replication_ip_whitelist="192.168.219.0/24,127.0.0.1/8"</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">重启mysql服务</span><br><span class="line">[root@mgr-node2 ~]# systemctl restart mysqld</span><br><span class="line">登录mysql进行相关设置操作</span><br><span class="line">[root@mgr-node2 ~]# mysql -uroot -p"123456"</span><br><span class="line">.........</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=0;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">如果报错按照上面的操作一遍</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO rpl_slave@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'slave@123'</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> reset master;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=1;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">  CHANGE MASTER TO MASTER_USER=<span class="string">'rpl_slave'</span>, MASTER_PASSWORD=<span class="string">'slave@123'</span> FOR CHANNEL <span class="string">'group_replication_recovery'</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.15 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> INSTALL PLUGIN group_replication SONAME <span class="string">'group_replication.so'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.24 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW PLUGINS;</span></span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library              | License |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| mysql_native_password      | ACTIVE   | AUTHENTICATION     | NULL                 | GPL     |</span><br><span class="line">| ........................................................................................    |</span><br><span class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">46 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START GROUP_REPLICATION;</span></span><br><span class="line">Query OK, 0 rows affected (5.73 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | aa4144da-cc7b-11ea-9fc8-000c2916b97f | mgr-node2   |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | aa42205a-cc7b-11ea-a8c3-000c29c57992 | mgr-node1   |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看下，发现已经将MGR-node1节点添加的数据同步过来了</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| kevin              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from kevin.haha;</span></span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | wangshibo |</span><br><span class="line">|  2 | guohuihui |</span><br><span class="line">|  3 | yangyang  |</span><br><span class="line">|  4 | shikui    |</span><br><span class="line">+----+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">=====================================================================</span><br><span class="line">3） MGR-node3节点操作</span><br><span class="line">[root@mgr-node3 ~]# cp /etc/my.cnf&#123;,.bak&#125;</span><br><span class="line">[root@mgr-node3 ~]# &gt;/etc/my.cnf</span><br><span class="line">[root@mgr-node3 ~]# cat /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">socket = /var/lib/mysql/mysql.sock</span><br><span class="line">      </span><br><span class="line">symbolic-links = 0</span><br><span class="line">      </span><br><span class="line">log-error = /var/log/mysqld.log</span><br><span class="line">pid-file = /var/run/mysqld/mysqld.pid</span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash">GTID:</span></span><br><span class="line">server_id = 3</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">  </span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">      </span><br><span class="line"><span class="meta">#</span><span class="bash">binlog</span></span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">log-slave-updates = 1</span><br><span class="line">binlog_format = row</span><br><span class="line">sync-master-info = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">     </span><br><span class="line"><span class="meta">#</span><span class="bash">relay <span class="built_in">log</span></span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line">  </span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name="58462f3b-ccd9-11ea-8eb2-000c29c57992"</span><br><span class="line">loose-group_replication_start_on_boot=off</span><br><span class="line">loose-group_replication_local_address= "192.168.219.153:24901"</span><br><span class="line">loose-group_replication_group_seeds= "192.168.219.151:24901,192.168.219.152:24901,192.168.219.153:24901"</span><br><span class="line">loose-group_replication_bootstrap_group=off</span><br><span class="line">loose-group_replication_single_primary_mode=off</span><br><span class="line">loose-group_replication_enforce_update_everywhere_checks=on</span><br><span class="line">loose-group_replication_ip_whitelist="192.168.219.0/24,127.0.0.1/8"</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">重启mysql服务</span><br><span class="line">[root@mgr-node3 ~]# systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">登录mysql进行相关设置操作</span><br><span class="line">[root@mgr-node3 ~]# mysql -uroot -p"123456"</span><br><span class="line">..........</span><br><span class="line"><span class="meta">#</span><span class="bash">报错请参考上面</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=0;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO rpl_slave@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'slave@123'</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> reset master;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET SQL_LOG_BIN=1;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_USER=<span class="string">'rpl_slave'</span>, MASTER_PASSWORD=<span class="string">'slave@123'</span> FOR CHANNEL <span class="string">'group_replication_recovery'</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">  INSTALL PLUGIN group_replication SONAME <span class="string">'group_replication.so'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.21 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW PLUGINS;</span></span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library              | License |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| .......................................................................................     |</span><br><span class="line">| validate_password          | ACTIVE   | VALIDATE PASSWORD  | validate_password.so | GPL     |</span><br><span class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">46 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START GROUP_REPLICATION;</span></span><br><span class="line">Query OK, 0 rows affected (5.91 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | aa4144da-cc7b-11ea-9fc8-000c2916b97f | mgr-node2   |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | aa42205a-cc7b-11ea-a8c3-000c29c57992 | mgr-node1   |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | aa9505ca-cc7b-11ea-9854-000c29a39eed | mgr-node3   |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看下，发现已经将在其他节点上添加的数据同步过来了</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| kevin              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from kevin.haha;</span></span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | wangshibo |</span><br><span class="line">|  2 | guohuihui |</span><br><span class="line">|  3 | yangyang  |</span><br><span class="line">|  4 | shikui    |</span><br><span class="line">+----+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">=====================================================================</span><br><span class="line">4） 组复制数据同步测试</span><br><span class="line">在任意一个节点上执行</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM performance_schema.replication_group_members;</span></span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | aa4144da-cc7b-11ea-9fc8-000c2916b97f | mgr-node2   |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | aa42205a-cc7b-11ea-a8c3-000c29c57992 | mgr-node1   |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | aa9505ca-cc7b-11ea-9854-000c29a39eed | mgr-node3   |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line">如上，说明已经在MGR-node1、MGR-node2、MGR-node3 三个节点上成功部署了基于GTID的组复制同步环境。</span><br><span class="line">现在在三个节点中的任意一个上面更新数据，那么其他两个节点的数据库都会将新数据同步过去的！</span><br><span class="line"> </span><br><span class="line">1）在MGR-node1节点数据库更新数据</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> delete from kevin.haha <span class="built_in">where</span> id&gt;2;</span></span><br><span class="line">Query OK, 2 rows affected (0.01 sec)</span><br><span class="line"> </span><br><span class="line">接着在MGR-node2、MGR-node3节点数据库查看，发现更新后数据已经同步过来了！</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from kevin.haha;</span></span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | wangshibo |</span><br><span class="line">|  2 | guohuihui |</span><br><span class="line">+----+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line">2）在MGR-node2节点数据库更新数据</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">  insert into kevin.haha values(11,<span class="string">"beijing"</span>),(12,<span class="string">"shanghai"</span>),(13,<span class="string">"anhui"</span>);</span></span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">接着在MGR-node1、MGR-node3节点数据库查看，发现更新后数据已经同步过来了！</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from kevin.haha;</span></span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | wangshibo |</span><br><span class="line">|  2 | guohuihui |</span><br><span class="line">| 11 | beijing   |</span><br><span class="line">| 12 | shanghai  |</span><br><span class="line">| 13 | anhui     |</span><br><span class="line">+----+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line">3）在MGR-node3节点数据库更新数据</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> update kevin.haha <span class="built_in">set</span> id=100 <span class="built_in">where</span> name=<span class="string">"anhui"</span>;</span></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"> </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> delete from kevin.haha <span class="built_in">where</span> id=12;</span></span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"> </span><br><span class="line">接着在MGR-node1、MGR-node2节点数据库查看，发现更新后数据已经同步过来了！</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from kevin.haha;</span></span><br><span class="line">+-----+-----------+</span><br><span class="line">| id  | name      |</span><br><span class="line">+-----+-----------+</span><br><span class="line">|   1 | wangshibo |</span><br><span class="line">|   2 | guohuihui |</span><br><span class="line">|  11 | beijing   |</span><br><span class="line">| 100 | anhui     |</span><br><span class="line">+-----+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="四、ProxySQL读写分离和主节点故障无感知切换"><a href="#四、ProxySQL读写分离和主节点故障无感知切换" class="headerlink" title="四、ProxySQL读写分离和主节点故障无感知切换"></a><strong>四、ProxySQL读写分离和主节点故障无感知切换</strong></h4><h5 id="1-安装mysql客户端，用于在本机连接到ProxySQL的管理接口"><a href="#1-安装mysql客户端，用于在本机连接到ProxySQL的管理接口" class="headerlink" title="1) 安装mysql客户端，用于在本机连接到ProxySQL的管理接口"></a><strong>1) 安装mysql客户端，用于在本机连接到ProxySQL的管理接口</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql-node ~]# yum install -y mariadb</span><br></pre></td></tr></table></figure>

<h5 id="2-安装proxysql"><a href="#2-安装proxysql" class="headerlink" title="2) 安装proxysql"></a><strong>2) 安装proxysql</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">把包全部都下载下来，后面会用到</span></span><br><span class="line">链接：https://pan.baidu.com/s/1Uw37OXlDTOphmabDWlvHug </span><br><span class="line">提取码：feru</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装proxysql</span></span><br><span class="line">[root@proxysql-node ~]# yum install -y proxysql-1.4.8-1-centos7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动proxysql</span></span><br><span class="line">[root@proxysql-node ~]# systemctl start proxysql</span><br><span class="line">[root@proxysql-node ~]# systemctl status proxysql.service </span><br><span class="line">● proxysql.service - LSB: High Performance Advanced Proxy for MySQL</span><br><span class="line">   Loaded: loaded (/etc/rc.d/init.d/proxysql; bad; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2020-07-23 20:24:39 CST; 1s ago</span><br><span class="line">     Docs: man:systemd-sysv-generator(8)</span><br><span class="line">  Process: 23727 ExecStart=/etc/rc.d/init.d/proxysql start (code=exited, status=0/SUCCESS)</span><br><span class="line">   CGroup: /system.slice/proxysql.service</span><br><span class="line">           ├─23731 proxysql -c /etc/proxysql.cnf -D /var/lib/proxysql</span><br><span class="line">           └─23732 proxysql -c /etc/proxysql.cnf -D /var/lib/proxysql</span><br><span class="line"></span><br><span class="line">Jul 23 20:24:39 proxysql-node systemd[1]: Starting LSB: High Performance Advanced Prox.....</span><br><span class="line">Jul 23 20:24:39 proxysql-node proxysql[23727]: Starting ProxySQL: DONE!</span><br><span class="line">Jul 23 20:24:39 proxysql-node systemd[1]: Started LSB: High Performance Advanced Proxy...L.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br><span class="line">[root@proxysql-node ~]# ss -lntp</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128               *:6032                          *:*                   users:(("proxysql",pid=23732,fd=23))</span><br><span class="line">LISTEN      0      128               *:6033                          *:*                   users:(("proxysql",pid=23732,fd=22))</span><br><span class="line">LISTEN      0      128               *:6033                          *:*                   users:(("proxysql",pid=23732,fd=21))</span><br><span class="line">LISTEN      0      128               *:6033                          *:*                   users:(("proxysql",pid=23732,fd=20))</span><br><span class="line">LISTEN      0      128               *:6033                          *:*                   users:(("proxysql",pid=23732,fd=19))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql-node ~]# mysql -uadmin -p&quot;admin&quot; -h127.0.0.1 -P6032</span><br><span class="line">............</span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | &#x2F;var&#x2F;lib&#x2F;proxysql&#x2F;proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | &#x2F;var&#x2F;lib&#x2F;proxysql&#x2F;proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">接着初始化Proxysql，将之前的proxysql数据都删除</span></span><br><span class="line">MySQL [(none)]&gt; delete from scheduler ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; delete from mysql_servers;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; delete from mysql_users;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; delete from mysql_query_rules;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; delete from mysql_group_replication_hostgroups ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL VARIABLES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL VARIABLES TO DISK;</span><br><span class="line">Query OK, 94 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL SERVERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL SERVERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;  LOAD MYSQL USERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL USERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD SCHEDULER TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE SCHEDULER TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL QUERY RULES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL QUERY RULES TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<h5 id="3）在数据库端建立proxysql登入需要的帐号-（在三个MGR任意一个节点上操作，会自动同步到其他节点）"><a href="#3）在数据库端建立proxysql登入需要的帐号-（在三个MGR任意一个节点上操作，会自动同步到其他节点）" class="headerlink" title="3）在数据库端建立proxysql登入需要的帐号 （在三个MGR任意一个节点上操作，会自动同步到其他节点）"></a><strong>3）在数据库端建立proxysql登入需要的帐号 （在三个MGR任意一个节点上操作，会自动同步到其他节点）</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@mgr-node3 ~]# mysql -uroot -p"123456"</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE USER <span class="string">'proxysql'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'proxysql'</span>;   </span></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT ALL ON * . * TO  <span class="string">'proxysql'</span>@<span class="string">'%'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create user <span class="string">'sbuser'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'sbpass'</span>; </span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT ALL ON * . * TO <span class="string">'sbuser'</span>@<span class="string">'%'</span>; </span></span><br><span class="line">Query OK, 0 rows affected (0.14 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;  </span></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<h5 id="4-创建检查MGR节点状态的函数和视图-（在三个MGR任意一个节点上操作，会自动同步到其他节点）"><a href="#4-创建检查MGR节点状态的函数和视图-（在三个MGR任意一个节点上操作，会自动同步到其他节点）" class="headerlink" title="4) 创建检查MGR节点状态的函数和视图 （在三个MGR任意一个节点上操作，会自动同步到其他节点）"></a><strong>4) 创建检查MGR节点状态的函数和视图 （在三个MGR任意一个节点上操作，会自动同步到其他节点）</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在MGR-node1节点上，创建系统视图sys.gr_member_routing_candidate_status，该视图将为ProxySQL提供组复制相关的监控状态指标。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">下载addition_to_sys.sql脚本，在MGR-node1节点执行如下语句导入MySQL即可 (在mgr-node1节点的mysql执行后，会同步到其他两个节点上)。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">脚本在刚才下载完了，上传就好。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">把addition_to_sys.sql脚本的数据导入到mysql中</span></span><br><span class="line">[root@mgr-node1 ~]# mysql -uroot -p"123456" &lt; /root/addition_to_sys.sql </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在三个mysql节点上可以查看该视图：</span><br><span class="line">[root@MGR-node1 ~]# mysql -p123456</span><br><span class="line">............</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from sys.gr_member_routing_candidate_status;</span></span><br><span class="line">+------------------+-----------+---------------------+----------------------+</span><br><span class="line">| viable_candidate | read_only | transactions_behind | transactions_to_cert |</span><br><span class="line">+------------------+-----------+---------------------+----------------------+</span><br><span class="line">| YES              | NO        |                   0 |                    0 |</span><br><span class="line">+------------------+-----------+---------------------+----------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<h5 id="5-在proxysql中增加帐号"><a href="#5-在proxysql中增加帐号" class="headerlink" title="5) 在proxysql中增加帐号"></a><strong>5) 在proxysql中增加帐号</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql-node ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span><br><span class="line">..........</span><br><span class="line">MySQL [(none)]&gt;  INSERT INTO MySQL_users(username,password,default_hostgroup) VALUES ('proxysql','proxysql',1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; UPDATE global_variables SET variable_value='proxysql' where variable_name='mysql-monitor_username';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; UPDATE global_variables SET variable_value='proxysql' where variable_name='mysql-monitor_password';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL SERVERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL SERVERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL VARIABLES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL VARIABLES TO DISK;</span><br><span class="line">Query OK, 94 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL SERVERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL SERVERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL USERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD SCHEDULER TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE SCHEDULER TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;  LOAD MYSQL QUERY RULES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL QUERY RULES TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; delete from mysql_servers;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers (hostgroup_id, hostname, port) values(1,'192.168.219.151',3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers (hostgroup_id, hostname, port) values(1,'192.168.219.152',3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers (hostgroup_id, hostname, port) values(1,'192.168.219.153',3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers (hostgroup_id, hostname, port) values(2,'192.168.219.151',3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers (hostgroup_id, hostname, port) values(2,'192.168.219.152',3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers (hostgroup_id, hostname, port) values(2,'192.168.219.153',3306);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers ;</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname        | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.152 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.153 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">hostgroup_id = 1代表write group，针对我们提出的限制，这个地方只配置了一个节点；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hostgroup_id = 2代表<span class="built_in">read</span> group，包含了MGR的所有节点,目前只是Onlinle的，等配置过scheduler后，status就会有变化 。</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash">对于上面的hostgroup配置，默认所有的写操作会发送到hostgroup_id为1的online节点，也就是发送到写节点上。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">所有的读操作，会发送为hostgroup_id为2的online节点。</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash">需要确认一下没有使用proxysql的读写分离规则（因为之前测试中配置了这个地方，所以需要删除，以免影响后面的测试）。</span></span><br><span class="line">MySQL [(none)]&gt;  delete from mysql_query_rules;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; commit;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL VARIABLES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL VARIABLES TO DISK;</span><br><span class="line">Query OK, 94 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL SERVERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL SERVERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL USERS TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL USERS TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; \q</span><br><span class="line">Bye</span><br><span class="line"><span class="meta">#</span><span class="bash">登录验证proxysql登录</span></span><br><span class="line">[root@proxysql-node ~]# mysql -uproxysql -pproxysql -h 127.0.0.1 -P6033 -e"select @@hostname"</span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node3  |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure>

<h5 id="7）配置scheduler"><a href="#7）配置scheduler" class="headerlink" title="7）配置scheduler"></a><strong>7）配置scheduler</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">有三中脚本，功能如下，网盘中的那个压缩包上传解压即可。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">proxysql_groupreplication_checker.sh：用于multi-primary模式，可以实现读写分离，以及故障切换，同一时间点多个节点可以多写；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gr_mw_mode_cheker.sh：用于multi-primary模式，可以实现读写分离，以及故障切换，不过在同一时间点只能有一个节点能写；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gr_sw_mode_checker.sh：用于single-primary模式，可以实现读写分离，以及故障切换；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">由于这里实验的环境是multi-primary模式，所以选择proxysql_groupreplication_checker.sh脚本。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql-node ~]# ls</span><br><span class="line">anaconda-ks.cfg  proxysql-1.4.8-1-centos7.x86_64.rpm</span><br><span class="line">a.sh             proxysql_groupreplication_checker-master.zip</span><br><span class="line">[root@proxysql-node ~]# unzip proxysql_groupreplication_checker-master.zip</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">将下载的脚本proxysql_groupreplication_checker.sh放到目录/var/lib/proxysql/下，并增加可以执行的权限:</span><br><span class="line">[root@proxysql-node ~]# cd proxysql_groupreplication_checker-master/</span><br><span class="line">[root@proxysql-node proxysql_groupreplication_checker-master]# cp proxysql_groupreplication_checker.sh /var/lib/proxysql/</span><br><span class="line">[root@proxysql-node proxysql_groupreplication_checker-master]# cd </span><br><span class="line">[root@proxysql-node ~]# chmod a+x /var/lib/proxysql/proxysql_groupreplication_checker.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">最后，在proxysql的scheduler表里面加载如下记录，然后加载到RUNTIME使其生效，同时还可以持久化到磁盘:</span></span><br><span class="line">执行语句：</span><br><span class="line">[root@proxysql-node ~]#  mysql -uadmin -padmin -h127.0.0.1 -P6032 </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 16</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; INSERT INTO scheduler(id,interval_ms,filename,arg1,arg2,arg3,arg4, arg5) VALUES (1,'10000','/var/lib/proxysql/proxysql_groupreplication_checker.sh','1','2','1','0','/var/lib/proxysql/proxysql_groupreplication_checker.log');</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select * from scheduler;</span><br><span class="line">+----+--------+-------------+--------------------------------------------------------+------+------+------+------+---------------------------------------------</span><br><span class="line">| id | active | interval_ms | filename                                               | arg1 | arg2 | arg3 | arg4 | arg5             | comment |</span><br><span class="line">+----+--------+-------------+--------------------------------------------------------+------+------+------+------+---------------------------------------------</span><br><span class="line">| 1 | 1 | 10000| /var/lib/proxysql/proxysql_groupreplication_checker.sh | 1  | 2  | 1 | 0 | /var/lib/proxysql/proxysql_groupreplication_checker.log |     |</span><br><span class="line">+----+--------+-------------+--------------------------------------------------------+------+------+------+------+---------------------------------------------</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD SCHEDULER TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE SCHEDULER TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">==============================================================================</span><br><span class="line"><span class="meta">#</span><span class="bash">scheduler各column的说明：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">active : 1: <span class="built_in">enable</span> scheduler to schedule the script we provide</span></span><br><span class="line"><span class="meta">#</span><span class="bash">interval_ms : invoke one by one <span class="keyword">in</span> cycle (eg: 5000(ms) = 5s represent every 5s invoke the script)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">filename: represent the script file path</span></span><br><span class="line"><span class="meta">#</span><span class="bash">arg1~arg5: represent the input parameters the script received</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">脚本proxysql_groupreplication_checker.sh对应的参数说明如下:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">arg1 is the hostgroup_id <span class="keyword">for</span> write</span></span><br><span class="line"><span class="meta">#</span><span class="bash">arg2 is the hostgroup_id <span class="keyword">for</span> <span class="built_in">read</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">arg3 is the number of writers we want active at the same time</span></span><br><span class="line"><span class="meta">#</span><span class="bash">arg4 represents <span class="keyword">if</span> we want that the member acting <span class="keyword">for</span> writes is also candidate <span class="keyword">for</span> reads</span></span><br><span class="line"><span class="meta">#</span><span class="bash">arg5 is the <span class="built_in">log</span> file</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">schedule信息加载后，就会分析当前的环境，mysql_servers中显示出当前只有192.168.219.151是可以写的，</span></span><br><span class="line">192.168.219.152以及192.168.219.153是用来读的。</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">会有延迟，没有信息就稍等一会</span></span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers ; </span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname        | port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">因为schedule的arg4，我这里设为了0，就表示可写的节点不能用于读。那我将arg4设置为1试一下：</span></span><br><span class="line">MySQL [(none)]&gt; update scheduler set arg4=1;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; select * from scheduler;</span><br><span class="line">+----+--------+-------------+--------------------------------------------------------+------+------+------+------+---------------------------------------------</span><br><span class="line">| id | active | interval_ms | filename                                               | arg1 | arg2 | arg3 | arg4 | arg5            | comment |</span><br><span class="line">+----+--------+-------------+--------------------------------------------------------+------+------+------+------+---------------------------------------------</span><br><span class="line">| 1  | 1| 10000| /var/lib/proxysql/proxysql_groupreplication_checker.sh | 1| 2| 1| 1 | /var/lib/proxysql/proxysql_groupreplication_checker.log |         |</span><br><span class="line">+----+--------+-------------+--------------------------------------------------------+------+------+------+------+---------------------------------------------</span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; SAVE SCHEDULER TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.286 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; LOAD SCHEDULER TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers;</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname        | port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line">arg4设置为1之后，192.168.219.151节点用来写的同时，也可以被用来读。</span><br><span class="line"> </span><br><span class="line">便于下面的测试还是将arg4设为0：</span><br><span class="line">MySQL [(none)]&gt; update scheduler set arg4=0;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; SAVE SCHEDULER TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.197 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; LOAD SCHEDULER TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers;</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname        | port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">各个节点的gr_member_routing_candidate_status视图也显示了当前节点是否是正常状态的，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">proxysql就是读取的这个视图的信息来决定此节点是否可用。</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from sys.gr_member_routing_candidate_status\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">    viable_candidate: YES</span><br><span class="line">           read_only: NO</span><br><span class="line"> transactions_behind: 0</span><br><span class="line">transactions_to_cert: 0</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>

<h5 id="8-设置读写分离"><a href="#8-设置读写分离" class="headerlink" title="8) 设置读写分离"></a><strong>8) 设置读写分离</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; insert into mysql_query_rules (active, match_pattern, destination_hostgroup, apply) values (1,"^SELECT",2,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; LOAD MYSQL QUERY RULES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SAVE MYSQL QUERY RULES TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">解释说明:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">match_pattern的规则是基于正则表达式的，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">active表示是否启用这个sql路由项，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">match_pattern就是我们正则匹配项，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">destination_hostgroup表示我们要将该类sql转发到哪些mysql上面去，这里我们将select转发到group 2，。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">apply为1表示该正则匹配后，将不再接受其他匹配，直接转发。</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">对于<span class="keyword">for</span> update需要在gruop1上执行，可以加上规则：</span></span><br><span class="line">MySQL [(none)]&gt; insert into mysql_query_rules(active,match_pattern,destination_hostgroup,apply) values(1,'^SELECT.*FOR UPDATE$',1,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"> </span><br><span class="line">在proxysql本机或其他客户机上检查下，select 语句，一直连接的是192.168.219.152和192.168.219.153</span><br><span class="line">[root@mgr-node3 ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node3  |</span><br><span class="line">+------------+</span><br><span class="line">[root@mgr-node3 ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node2  |</span><br><span class="line">+------------+</span><br><span class="line">[root@mgr-node3 ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node2  |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure>

<h5 id="9-验证数据的读写分离效果"><a href="#9-验证数据的读写分离效果" class="headerlink" title="9) 验证数据的读写分离效果"></a><strong>9) 验证数据的读写分离效果</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql-node ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"  </span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node2  |</span><br><span class="line">+------------+</span><br><span class="line">[root@proxysql-node ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"  </span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node3  |</span><br><span class="line">+------------+</span><br><span class="line">[root@proxysql-node ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"  </span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node2  |</span><br><span class="line">+------------+</span><br><span class="line">[root@proxysql-node ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"  </span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node2  |</span><br><span class="line">+------------+</span><br><span class="line">[root@proxysql-node ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"  </span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node3  |</span><br><span class="line">+------------+</span><br><span class="line">[root@proxysql-node ~]#  mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select * from kevin.haha"</span><br><span class="line">+-----+-----------+</span><br><span class="line">| id  | name      |</span><br><span class="line">+-----+-----------+</span><br><span class="line">|   1 | wangshibo |</span><br><span class="line">|   2 | guohuihui |</span><br><span class="line">|  11 | beijing   |</span><br><span class="line">| 100 | anhui     |</span><br><span class="line">+-----+-----------+</span><br><span class="line">[root@proxysql-node ~]#  mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "delete from kevin.haha where id=1;"</span><br><span class="line">[root@proxysql-node ~]#  mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "delete from kevin.haha where id=2;"</span><br><span class="line">[root@proxysql-node ~]#  mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select * from kevin.haha"</span><br><span class="line">+-----+---------+</span><br><span class="line">| id  | name    |</span><br><span class="line">+-----+---------+</span><br><span class="line">|  11 | beijing |</span><br><span class="line">| 100 | anhui   |</span><br><span class="line">+-----+---------+</span><br><span class="line">[root@proxysql-node ~]#  mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e 'insert into kevin.haha values(21,"zhongguo"),(22,"xianggang"),(23,"taiwan");'</span><br><span class="line">[root@proxysql-node ~]#  mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select * from kevin.haha"</span><br><span class="line">+-----+-----------+</span><br><span class="line">| id  | name      |</span><br><span class="line">+-----+-----------+</span><br><span class="line">|  11 | beijing   |</span><br><span class="line">|  21 | zhongguo  |</span><br><span class="line">|  22 | xianggang |</span><br><span class="line">|  23 | taiwan    |</span><br><span class="line">| 100 | anhui     |</span><br><span class="line">+-----+-----------+</span><br><span class="line"><span class="meta">#</span><span class="bash">最后在proxysql管理端查看读写分离情况</span></span><br><span class="line">[root@proxysql-node ~]# mysql -uadmin -p"admin" -h127.0.0.1 -P6032</span><br><span class="line">...........</span><br><span class="line">MySQL [(none)]&gt; select hostgroup,username,digest_text,count_star from stats_mysql_query_digest;</span><br><span class="line">+-----------+----------+--------------------------------------------------------------------+------------+</span><br><span class="line">| hostgroup | username | digest_text                                                        | count_star |</span><br><span class="line">+-----------+----------+--------------------------------------------------------------------+------------+</span><br><span class="line">| 1         | proxysql | insert into kevin.haha values(?,zhongguo),(?,xianggang),(?,taiwan) | 1          |</span><br><span class="line">| 1         | proxysql | delete from kevin.haha where id=?                                  | 2          |</span><br><span class="line">| 1         | proxysql | insert into kevin.haha values(?,?),(?,?),(?,?)                     | 1          |</span><br><span class="line">| 2         | proxysql | select * from kevin.haha                                           | 3          |</span><br><span class="line">| 2         | proxysql | select @@hostname                                                  | 12         |</span><br><span class="line">| 1         | proxysql | select @@hostname                                                  | 9          |</span><br><span class="line">| 1         | proxysql | select @@version_comment limit ?                                   | 28         |</span><br><span class="line">+-----------+----------+--------------------------------------------------------------------+------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers;</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname        | port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">通过上面可以看到：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">写操作都分配到了group1组内，即写操作分配到192.168.219.151节点上。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">读操作都分配到了group2组内，即读操作分配到192.168.219.152,192.168.219.153节点上。</span></span><br></pre></td></tr></table></figure>

<h5 id="10）设置故障应用无感应"><a href="#10）设置故障应用无感应" class="headerlink" title="10）设置故障应用无感应"></a><strong>10）设置故障应用无感应</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在上面的读写分离规则中，我设置了192.168.219.151为可写节点，192.168.219.152,192.168.219.153为只读节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果此时192.168.219.151变成只读模式的话，应用能不能直接连到其它的节点进行写操作？</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash">现手动将192.168.219.151变成只读模式：</span></span><br><span class="line">[root@mgr-node1 ~]# mysql -uroot -p"123456"</span><br><span class="line">........</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global read_only=1;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">接着观察一下mysql_servers的状态，自动将group1的192.168.219.152改成了online，group2的192.168.219.151,192.168.219.153变成online了，就表示将192.168.219.152变为可写节点，其它两个节点变为只读节点了。</span></span><br><span class="line">[root@proxysql-node ~]# mysql -uadmin -padmin -h 127.0.0.1 -P6032</span><br><span class="line">........</span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers;</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname        | port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.152 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">通过模拟的连接也可以看到select语句都连接到192.168.219.151和192.168.219.153进行了。 (模拟时可以稍微间隔一段时间，快速测试可能会连接同一个读节点)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@mgr-node3 ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node1  |</span><br><span class="line">+------------+</span><br><span class="line">[root@mgr-node3 ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node3  |</span><br><span class="line">+------------+</span><br><span class="line">[root@mgr-node3 ~]# mysql -uproxysql -pproxysql -h192.168.219.154 -P6033 -e "select @@hostname"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------+</span><br><span class="line">| @@hostname |</span><br><span class="line">+------------+</span><br><span class="line">| mgr-node1  |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">然后再将将192.168.219.151变为可写模式后，mysql_servers也恢复过来了。</span></span><br><span class="line">[root@mgr-node1 ~]# mysql -uroot -p"123456"</span><br><span class="line">........</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global read_only=0;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">接着观察一下mysql_servers的状态</span></span><br><span class="line">[root@proxysql-node ~]# mysql -uadmin -padmin -h 127.0.0.1 -P6032</span><br><span class="line">........</span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers;</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-------------</span><br><span class="line">| hostgroup_id | hostname        | port | status       | weight | compression | max_connecti</span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-------------</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000        </span><br><span class="line">| 1            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000        </span><br><span class="line">| 1            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000        </span><br><span class="line">| 2            | 192.168.219.151 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000        </span><br><span class="line">| 2            | 192.168.219.152 | 3306 | ONLINE       | 1      | 0           | 1000        </span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE       | 1      | 0           | 1000        </span><br><span class="line">+--------------+-----------------+------+--------------+--------+-------------+-------------</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"><span class="meta">#</span><span class="bash">经过测试将192.168.219.151节点停止组复制（stop group_replication）或者该节点宕机(mysql服务挂掉)后，mysql_servers表的信息也会正常的切换新的节点。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">待192.168.219.151恢复再加入到组复制后，mysql_servers也会正常的将192.168.219.151改成online状态。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">可能出现的问题:</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">  select * from  mysql_servers ;</span></span><br><span class="line">+--------------+---------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname      | port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+---------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | OFFLINE_HARD | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+---------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">也就是说，可能遇到上面所有节点都offline了的情况，查看错误日志如下：</span></span><br><span class="line">[root@proxysql-node ~]# tail -f /var/lib/proxysql/proxysql.log</span><br><span class="line">........</span><br><span class="line">[2019-02-18 16:23:52] read node [hostgroup_id: 2, hostname: 192.168.219.153, port: 3306, isOK: 0] is not OK, we will set it's status to be 'OFFLINE_SOFT'</span><br><span class="line">ERROR 1142 (42000) at line 1: SELECT command denied to user 'proxysql'@'192.168.219.154' for table 'gr_member_routing_candidate_status'</span><br><span class="line">[2019-02-18 16:23:55] current write node [hostgroup_id: 2, hostname:192.168.219.151, port: 3306, isOK: 0] is not OK, we need to do switch over</span><br><span class="line">ERROR 1142 (42000) at line 1: SELECT command denied to user 'proxysql'@'192.168.219.154' for table 'gr_member_routing_candidate_status'</span><br><span class="line">[2019-02-18 16:23:55] read node [hostgroup_id: 2, hostname: 192.168.219.152, port: 3306, isOK: 0] is not OK, we will set it's status to be 'OFFLINE_SOFT'</span><br><span class="line">ERROR 1142 (42000) at line 1: SELECT command denied to user 'proxysql'@'192.168.219.154' for table 'gr_member_routing_candidate_status</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">从上面的错误日志上看出是权限的问题，proxysql用户没有足够的权限读取数据。</span></span><br><span class="line"> </span><br><span class="line">解决办法：</span><br><span class="line">[root@mgr-node1 ~]# mysql -uroot -p"123456"</span><br><span class="line">.........</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT ALL ON * . * TO  <span class="string">'proxysql'</span>@<span class="string">'%'</span>; </span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br><span class="line"> </span><br><span class="line">再次看看，就有权限了</span><br><span class="line">[root@proxysql-node ~]# mysql -uadmin -padmin -h 127.0.0.1 -P6032</span><br><span class="line">.........</span><br><span class="line">MySQL [(none)]&gt; select * from  mysql_servers;</span><br><span class="line">+--------------+---------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname      | port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+---------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 1            | 192.168.219.151 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.152 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.219.153 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.151 | 3306 | OFFLINE_SOFT | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.152 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 2            | 192.168.219.153 | 3306 | ONLINE       | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+---------------+------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">6 rows in set (0.000 sec)</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">MiaoZhenChao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.luanyu.cool/2019/03/12/ProxySQL+MGR/">http://www.luanyu.cool/2019/03/12/ProxySQL+MGR/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.luanyu.cool" target="_blank">ZhenChaoNotes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ProxySQL/">ProxySQL</a><a class="post-meta__tags" href="/tags/MGR/">MGR</a></div><div class="post_share"><div class="social-share" data-image="https://ssyerv1.oss-cn-hangzhou.aliyuncs.com/picture/dc5854e39f8e48fe990ad13bf4667336.jpg!sswm" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="wechat" onclick="window.open('http://123.57.180.161/wechat.jpg')"/><div class="post-qr-code__desc">wechat</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="alipay" onclick="window.open('http://123.57.180.161/alipay.jpg')"/><div class="post-qr-code__desc">alipay</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/03/13/linux-wa%25%E8%BF%87%E9%AB%98%EF%BC%8Ciostat%E6%9F%A5%E7%9C%8Bio%E7%8A%B6%E5%86%B5/"><img class="prev-cover" data-src="https://ssyerv1.oss-cn-hangzhou.aliyuncs.com/picture/002115827ab54b7dac605f61bb27eaa9.jpg!sswm" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">linux wa%过高，iostat查看io状况</div></div></a></div><div class="next-post pull-right"><a href="/2019/03/12/%E6%88%B4%E5%B0%94%E6%83%A0%E6%99%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E5%8F%8A%E4%BB%B7%E6%A0%BC/"><img class="next-cover" data-src="https://ssyerv1.oss-cn-hangzhou.aliyuncs.com/picture/474218e81bcb44a1bff607cd329324bd.jpg!sswm" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">戴尔惠普服务器配置及价格</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'http://www.luanyu.cool/2019/03/12/ProxySQL+MGR/';
  this.page.identifier = '2019/03/12/ProxySQL+MGR/';
  this.page.title = 'ProxySQL+MGR';
};
(function() { 
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script><script>function getDisqusCount() {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
}

window.addEventListener('load', getDisqusCount, false);</script></div></article></main><footer id="footer" style="background-image: url(https://ssyerv1.oss-cn-hangzhou.aliyuncs.com/picture/b63ba4dd15334a819ef187c482845267.jpg!sswm)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2010 - 2021 By MiaoZhenChao</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="/">blog</a>!</div><div class="icp"><a href="http://www.beian.miit.gov.cn/state/outPortal/loginPortal.action" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"/><span>豫ICP备20019375号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">繁</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script defer id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/search/local-search.js"></script><script>if (document.getElementsByClassName('mermaid').length) {
  loadScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js',function () {
    mermaid.initialize({
      theme: 'default',
  })
})
}</script><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@latest/Hexo/js/mouse_snow.min.js"></script><script src="/js/Lete.js"></script><script src="/js/daovoice.js"></script><script type="text/javascript" src="/js/crash_cheat.js"></script></body></html>